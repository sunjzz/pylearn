define(function(r,p,t){var o="http://vip.yinyuetai.com/vip/check-vip";var u,n,v;u=r("cookie");v=r("ajax");n=Backbone.Model.extend({defaults:{userName:"",userId:0},isLogined:function(){return parseInt(this.get("userId"))?true:false},onLogin:function(a){this.on("logined",a)},logined:function(a){if(this.isLogined()){a()}else{this.on("logined",a)}},login:function(c,a){var b=this;if(this.isLogined()){c()}else{this.on("login",c);r(["loginBox"],function(d){d.trigger("show");d.once("hide",function(){b.off("login");a&&a()})})}},emit:function(){var a,b;a=u.get("token");b=u.get("u_inf");if(a!=null){if(b!=null&&b.length>0){l(b)}else{m()}}},getUserInfo:function(d,c){if(this.isLogined()){var a=this;var b=function(){if(typeof d==="function"){return a.toJSON()}else{return a.get(d)}};if(a.has("isEmailVerified")){c&&c(b())}else{m(function(){c&&c(b())})}}},checkEmail:function(a){this.getUserInfo("isEmailVerified",function(c){if(!c){var b='<div style="padding: 20px 30px;"><p>您好像还没有进行邮箱验证。</p><p>为不影响部分功能的使用，请先进行 <a href="'+Y.domains.homeSite+'/settings/bind" target="_blank" class="special f14">邮箱验证</a></p></div>';r(["dialog"],function(d){new d(b,{title:"邮箱验证",width:400,height:100,isAutoShow:true})})}else{if(a){a()}}})},checkVIP:function(c,b){if(!this.isLogined()){this.login(function(){s(c,b)},b)}else{if(q.get("vipInfo")){var a=q.get("vipInfo");if(a&&!a.error&&a.realVip&&parseInt(a.realVip)>0){c(a)}else{b()}}else{s(c,b)}}},isVipUser:function(){var b=u.get("token");if(b){var a=b.split(".");var c;if(a.length>2){c=a[2];return parseInt(c[0])>0}}return false},getToken:function(){return u.get("token")}});function l(b){var a,c;a=String.fromCharCode(2);b=decodeURIComponent(b);c=b.split(a);q.set({userId:c[0]*1,userName:c[1]})}function m(a){v.getJSON(Y.domains.loginSite+"/login-info","",function(b){q.set(b);a&&a()})}function s(a,b){$.ajax({url:o,type:"get",dataType:"jsonp",jsonp:"callback",success:function(c){if(c&&!c.error){if((c.realVip&&parseInt(c.realVip)>0)||c.isWo){q.set("vipInfo",c);a(c);return}}b()},error:function(){b()}})}var q=new n();q.on("change:userId",function(){q.trigger("logined");q.trigger("login")});q.emit();return q});